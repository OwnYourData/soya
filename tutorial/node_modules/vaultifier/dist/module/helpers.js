var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { decrypt, isEncrypted } from './crypto';
export const parseVaultItemMeta = (data) => ({
    id: data.id,
    accessCount: data.access_count,
    createdAt: new Date(data.created_at),
    updatedAt: new Date(data.updated_at),
    tableName: data.table_name,
    dri: data.dri,
    schemaDri: data.schema_dri,
    mimeType: data.mime_type,
    merkleId: data.merkle_id,
    oydHash: data.oyd_hash,
    oydSourcePileId: data.oyd_source_pile_id,
    raw: data,
});
export const decryptOrNot = (item, privateKey) => __awaiter(void 0, void 0, void 0, function* () {
    if (privateKey &&
        isEncrypted(item)) {
        const decrypted = yield decrypt(item, { cipher: privateKey });
        try {
            return JSON.parse(decrypted);
        }
        catch ( /* the encrypted data is delivered as string */_a) { /* the encrypted data is delivered as string */ }
    }
    return item;
});
export const parseVaultItem = (data, privateKey) => __awaiter(void 0, void 0, void 0, function* () {
    if (typeof data === 'string') {
        try {
            // item usually contains JSON data, therefore we try to parse the string
            data = JSON.parse(data);
        }
        catch ( /* */_b) { /* */ }
    }
    const isContentEncrypted = isEncrypted(data.content);
    data.content = yield decryptOrNot(data.content, privateKey);
    const item = Object.assign(Object.assign({}, parseVaultItemMeta(data)), { isEncrypted: isContentEncrypted, content: data.content });
    return item;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLE9BQU8sRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBR2hELE1BQU0sQ0FBQyxNQUFNLGtCQUFrQixHQUFHLENBQUMsSUFBUyxFQUFhLEVBQUUsQ0FBQyxDQUFDO0lBQzNELEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtJQUNYLFdBQVcsRUFBRSxJQUFJLENBQUMsWUFBWTtJQUM5QixTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUNwQyxTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUNwQyxTQUFTLEVBQUUsSUFBSSxDQUFDLFVBQVU7SUFDMUIsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO0lBQ2IsU0FBUyxFQUFFLElBQUksQ0FBQyxVQUFVO0lBQzFCLFFBQVEsRUFBRSxJQUFJLENBQUMsU0FBUztJQUN4QixRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVM7SUFDeEIsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRO0lBQ3RCLGVBQWUsRUFBRSxJQUFJLENBQUMsa0JBQWtCO0lBQ3hDLEdBQUcsRUFBRSxJQUFJO0NBQ1YsQ0FBQyxDQUFDO0FBRUgsTUFBTSxDQUFDLE1BQU0sWUFBWSxHQUFHLENBQU8sSUFBUyxFQUFFLFVBQW1CLEVBQWdCLEVBQUU7SUFDakYsSUFDRSxVQUFVO1FBQ1YsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUNqQjtRQUNBLE1BQU0sU0FBUyxHQUFHLE1BQU0sT0FBTyxDQUFDLElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRTlELElBQUk7WUFDRixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDOUI7UUFBQyxRQUFRLCtDQUErQyxJQUFqRCxFQUFFLCtDQUErQyxFQUFFO0tBQzVEO0lBRUQsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDLENBQUEsQ0FBQTtBQUVELE1BQU0sQ0FBQyxNQUFNLGNBQWMsR0FBRyxDQUFPLElBQVMsRUFBRSxVQUFtQixFQUFzQixFQUFFO0lBQ3pGLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQzVCLElBQUk7WUFDRix3RUFBd0U7WUFDeEUsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDekI7UUFBQyxRQUFRLEtBQUssSUFBUCxFQUFFLEtBQUssRUFBRTtLQUNsQjtJQUVELE1BQU0sa0JBQWtCLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNyRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFFNUQsTUFBTSxJQUFJLG1DQUNMLGtCQUFrQixDQUFDLElBQUksQ0FBQyxLQUMzQixXQUFXLEVBQUUsa0JBQWtCLEVBQy9CLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxHQUN0QixDQUFDO0lBRUYsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDLENBQUEsQ0FBQSJ9